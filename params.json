{"name":"Activerecord-relation-behavior","body":"# ActiveRecord Relation Behavior\r\n\r\nThis extension is inspired by all the yii extensions that aim to improve saving of related records.\r\nIt allows you to assign related records especially for MANY_MANY relations more easily.\r\nIt puts together the awesomeness of all the extensions mentionend below (see headline \"Feature comparison\").\r\nIt comes with 100% test coverage and well structured and clean code so it can savely be used in enterprise production enviroment.\r\n\r\n\r\n## Requirements\r\n\r\n* Yii 1.1.6 or above\r\n* As Yii Framework this behavior is compatible with all PHP versions above 5.1.0.\r\n  I try to be at least as backwards compatible as Yii is, which is PHP 5.1.0,\r\n  if there are any problems with php versions, please [report it](https://github.com/yiiext/activerecord-relation-behavior/issues)!\r\n* Behavior will only work for ActiveRecord classes that have primary key defined.\r\n  Make sure to override [primaryKey()](http://www.yiiframework.com/doc/api/1.1/CActiveRecord#primaryKey%28%29-detail) method when your\r\n  table does not define a primary key.\r\n* _You need php 5.3.x or higher to run the unit tests._\r\n\r\n\r\n## How to install\r\n\r\n1. Get the source in one of the following ways:\r\n   * [Download](https://github.com/yiiext/activerecord-relation-behavior/tags) the latest version and place the files under\r\n     `extensions/yiiext/behaviors/activerecord-relation/` under your application root directory.\r\n   * Add this repository as a git submodule to your repository by calling\r\n     `git submodule add https://github.com/yiiext/activerecord-relation-behavior.git extensions/yiiext/behaviors/activerecord-relation`\r\n2. Add it to the models you want to use it with, by adding it to the `behaviors()` method.\r\n\r\n~~~php\r\n<?php\r\npublic function behaviors()\r\n{\r\n    return array(\r\n        'activerecord-relation'=>array(\r\n            'class'=>'ext.yiiext.behaviors.activerecord-relation.EActiveRecordRelationBehavior',\r\n    );\r\n}\r\n~~~\r\n\r\n\r\n## Let the magic begin...\r\n\r\nWe have two ActiveRecord classes (the ones from [Yii definitive guide](http://www.yiiframework.com/doc/guide/1.1/en/database.arr#declaring-relationship)):\r\n```php\r\n<?php\r\nclass Post extends CActiveRecord\r\n{\r\n    // ...\r\n    public function relations()\r\n    {\r\n        return array(\r\n            'author'     => array(self::BELONGS_TO, 'User',     'author_id'),\r\n            'categories' => array(self::MANY_MANY,  'Category', 'tbl_post_category(post_id, category_id)'),\r\n        );\r\n    }\r\n}\r\n\r\nclass User extends CActiveRecord\r\n{\r\n    // ...\r\n    public function relations()\r\n    {\r\n        return array(\r\n            'posts'   => array(self::HAS_MANY, 'Post',    'author_id'),\r\n            'profile' => array(self::HAS_ONE,  'Profile', 'owner_id'),\r\n        );\r\n    }\r\n}\r\n```\r\n\r\nSomewhere in our application code we can do:\r\n```php\r\n<?php\r\n    $user = new User();\r\n    $user->posts = array(1,2,3);\r\n    $user->save();\r\n    // user is now author of posts 1,2,3\r\n\r\n    // this is equivalent to the last example:\r\n    $user = new User();\r\n    $user->posts = Post::model()->findAllByPk(array(1,2,3));\r\n    $user->save();\r\n    // user is now author of posts 1,2,3\r\n\r\n    $user->posts = array_merge($user->posts, array(4));\r\n    $user->save();\r\n    // user is now also author of post 4\r\n\r\n    $user->posts = array();\r\n    $user->save();\r\n    // user is not related to any post anymore\r\n\r\n    $post = Post::model()->findByPk(2);\r\n    $post->author = User::model()->findByPk(1);\r\n    $post->categories = array(2, Category::model()->findByPk(5));\r\n    $post->save();\r\n    // post 2 has now author 1 and belongs to categories 1 and 5\r\n\r\n    // adding a profile to a user:\r\n    $user->profile = new Profile();\r\n    $user->profile->save(); // need this to ensure profile got a primary key\r\n    $user->save();\r\n```\r\n\r\n\r\n## Some things you should care about...\r\n\r\n* once you use this behavior you can not set relations by setting the foreign key attributes anymore.\r\n  For example if you set `$model->author_id` it will have no effect since ARRelationBehavior will overwrite it\r\n  with null if there is no related record or set it to related records primary key.\r\n  Instead simply assign the value to the relation itself: `$model->author = 1;` / `$model->author = null;`\r\n* relations will not be refreshed after saving, so if you only set primary keys there are no objects yet.\r\n  Call `$model->reload()` to force reloading of related records. Or load related records with forcing reload:\r\n  `$model->getRelated('relationName',true)`.\r\n* This behavior will only work for relations that do not have additional conditions, joins, groups\r\n  or the like defined since the expected result after setting and saving them is not always clear.\r\n* if you assigned a record to a BELONGS_TO relation, for example `$post->author = $user;`,\r\n  `$user->posts` will not be updated automatically (might add this as a feature later).\r\n\r\n\r\n## Exceptions explained\r\n\r\n### \"You can not save a record that has new related records!\"\r\n\r\nYou have assigned a record to a relation which has not been saved (it is not in the database yet).\r\nSince ActiveRecord Relation Behavior needs its primary key to save it to a relation table, this will not work.\r\nYou have to call `->save()` on all new records before saving the related record.\r\n\r\n### \"A HAS_MANY/MANY_MANY relation needs to be an array of records or primary keys!\"\r\n\r\nYou can only assing arrays to HAS_MANY and MANY_MANY relations, assigning a single record to a ..._MANY relation is not possible.\r\n\r\n### \"Related record with primary key \"X\" does not exist!\"\r\n\r\nYou tried to assign primary key value _X_ to a relation, but _X_ does not exist in your database.\r\n\r\n\r\n## Feature comparison\r\n\r\nInspired by and put together the awesomeness of the following yii extensions:\r\n\r\n- can save MANY_MANY relations like cadvancedarbehavior, eadvancedarbehavior, esaverelatedbehavior and advancedrelationsbehavior\r\n- cares about relations when records get deleted like eadvancedarbehavior (not yet implemented, see github [issue #7](https://github.com/yiiext/activerecord-relation-behavior/issues/7))\r\n- can save BELONGS_TO, HAS_MANY, HAS_ONE like eadvancedarbehavior, esaverelatedbehavior and advancedrelationsbehavior\r\n- saves with transaction and can handle external transactions like with-related-behavior, esaverelatedbehavior and saverbehavior\r\n- does not touch additional data in MANY_MANY table (cadvancedarbehavior deleted it)\r\n- validates for array on HAS_MANY and MANY_MANY relation to have more clear semantic\r\n\r\nthese are the extensions mentioned above\r\n- cadvancedarbehavior        http://www.yiiframework.com/extension/cadvancedarbehavior/\r\n- eadvancedarbehavior        http://www.yiiframework.com/extension/eadvancedarbehavior\r\n- advancedrelationsbehavior  http://www.yiiframework.com/extension/advancedrelationsbehavior\r\n- saverbehavior              http://www.yiiframework.com/extension/saverbehavior\r\n- with-related-behavior      https://github.com/yiiext/with-related-behavior\r\n- CSaveRelationsBehavior     http://code.google.com/p/yii-save-relations-ar-behavior/\r\n- esaverelatedbehavior       http://www.yiiframework.com/extension/esaverelatedbehavior\r\n\r\nreviewed but did not take something out:\r\n- xrelationbehavior          http://www.yiiframework.com/extension/xrelationbehavior\r\n- save-relations-ar-behavior http://www.yiiframework.com/extension/save-relations-ar-behavior\r\n\r\nMany thanks to the authors of these extensions for inpiration and ideas.\r\n\r\n\r\n## Run the unit test\r\n\r\nThis behavior is covered by unit tests with 100% code coverage (ECompositeDbCriteria is currently not covered since composite pks are not fully supported yet).\r\nTo run the unit tests you need [phpunit](https://github.com/sebastianbergmann/phpunit#readme) installed\r\nand the test class requires php 5.3 or above.\r\n\r\n1. make sure yii framework is available under ./yii/framework\r\n   you can do this by\r\n   - cloning the yii git repo with `git clone https://github.com/yiisoft/yii.git yii`\r\n   - or linking existing yii directory here with `ln -s ../../path/to/yii yii`\r\n2. run `phpunit EActiveRecordRelationBehaviorTest.php` or if you want coverage information in html,\r\n   run `phpunit --coverage-html tmp/coverage EActiveRecordRelationBehaviorTest.php`\r\n\r\n\r\n## FAQ\r\n\r\n### When using a MANY_MANY relation, not changing it in any way and doing save() does it re-save relations or not?\r\n\r\nIt uses `CActiveRecord::hasRelated()` to check if a relation has been\r\nloaded or set and will only save if this is the case.\r\nIt will re-save if you loaded and did not change, since it is not able\r\nto detect this.\r\nBut re-saving does not mean entries in MANY_MANY table get deleted and\r\nre-inserted. It will only run a delete query, that does not match any rows if you\r\ndid not touch records, so no row in db will be touched.\r\n\r\n### is it possible to save only related links (n-m table records) without re-saving model?\r\n\r\nCurrently not, will add this feature in the future: [issue #16](https://github.com/yiiext/activerecord-relation-behavior/issues/16).\r\n\r\n### how can I delete a particular id from many-many relation? do I need to load all related records for this?\r\n\r\nCurrently you have to load all and re-assign the array. Will add an api for this; [issue #16](https://github.com/yiiext/activerecord-relation-behavior/issues/16).\r\n","tagline":"Inspired by and put together the awesomeness of many yii extensions that aim to improve saving of related records. Comes with 100% test coverage and well structured and clean code so it can savely be used in enterprise production enviroment.","google":"","note":"Don't delete this file! It's used internally to help with page regeneration."}